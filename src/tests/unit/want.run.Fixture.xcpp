// This is -*- c++ -*- nearly C++2a with Modules TS but in the S.C.O.L.D. stylings that are so popular these days.
// Copyright (c) 2019 Verizon Media, Inc.  See the LICENSE statement nearby.
#divert <fpp>
namespace tests::unit::want::run { class Fixture; }
#endiv
#divert <hpp>
#import cppunit.Test
#import cppunit.test.Fixture
class tests::unit::want::run::Fixture : public cppunit::test::Fixture {
public:
  auto test_Runner() -> void;
  auto test_Piped_From() -> void;
  auto test_Piped_To() -> void;
  static auto suite() -> cppunit::Test *;
protected:
  struct Runner;
  struct Piped_From;
  struct Piped_To;
};
#endiv
#divert <cpp>
#import std.string_literals
using namespace std::string_literals;
#import tests.unit.want.run.Fixture.Runner
auto tests::unit::want::run::Fixture::test_Runner() -> void {
  Runner go;
  auto ran = go.run();
  CPPUNIT_ASSERT(ok(ran));
}
#import std.cerr
#import tests.unit.want.run.Fixture.Piped_From
#import std.getline
auto tests::unit::want::run::Fixture::test_Piped_From() -> void {
  Piped_From go;
  auto started = go.start();
  CPPUNIT_ASSERT(ok(started));
  std::string payload;
  // WATCHOUT - if you use operator>> to read payload, it will stop at the first whitespace, else use std::noskipws.
  if (std::getline(go.stream(), payload).eof()) {
    CPPUNIT_ASSERT(true);
  } else {
    std::string lastcall; 
    if (std::getline(go.stream(), lastcall).eof() && lastcall.empty()) {
      CPPUNIT_ASSERT(true);
    } else {
      std::cerr << "not at eof, but got |" << payload << "|\n";
      CPPUNIT_ASSERT(false);
    }
  }
  auto waited = go.wait();
  CPPUNIT_ASSERT(ok(waited));
}
#import tests.unit.want.run.Fixture.Piped_To
auto tests::unit::want::run::Fixture::test_Piped_To() -> void {
  Piped_To go;
  auto started = go.start();
  CPPUNIT_ASSERT(ok(started));
  go.stream() << "And on the seventh day the camel died...";
  if (go.stream().good()) {
    CPPUNIT_ASSERT(true);
  } else {
    CPPUNIT_ASSERT(false);
  }
  auto waited = go.wait();
  CPPUNIT_ASSERT(ok(waited));
}
#import unit.rigging.suite.Stream
#import unit.rigging.suite.call
#import unit.rigging.suite.add
auto tests::unit::want::run::Fixture::suite() -> cppunit::Test * {
  using namespace ::unit::rigging::suite;
  Stream series("run");
  series << call("Runner", &Fixture::test_Runner)
         << call("Piped_From", &Fixture::test_Piped_From)
         << call("Piped_To", &Fixture::test_Piped_To)
    ;
  return series.release();
}
#endiv
